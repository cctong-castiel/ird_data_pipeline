version: 2

build:
  - prefect.deployments.steps.set_working_directory:
      directory: ./
  - prefect.deployments.steps.run_shell_script:
      script: pip install -r lib/requirements.txt

deployments:
  - name: ird-data-pipeline-deployment
    entrypoint: ./src/pipelines/scrape_flow.py:ird_scrape_data_dag  # Change to your actual flow function if needed
    work_pool:
      name: ird-data-pool
      job_variables:
        image: cctongcastiel/ird_data_test_scrape:0.0.1
        dockerhub_username: "${{ secrets.DOCKER_USERNAME }}"
        dockerhub_password: "${{ secrets.DOCKER_PASSWORD }}"
    env:
      PREFECT_API_KEY: "${{ secrets.PREFECT_API_KEY }}"
      PREFECT_API_URL: "${{ secrets.PREFECT_API_URL }}"
      AWS_OPENSEARCH_ENDPOINT: "${{ secrets.AWS_OPENSEARCH_ENDPOINT }}"
      AWS_OPENSEARCH_USERNAME: "${{ secrets.AWS_OPENSEARCH_USERNAME }}"
      AWS_OPENSEARCH_PASSWORD: "${{ secrets.AWS_OPENSEARCH_PASSWORD }}"
      AWS_ACCESS_KEY_ID: "${{ secrets.AWS_ACCESS_KEY_ID }}"
      AWS_SECRET_ACCESS_KEY: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
    parameters: {}
    schedule: null
    tags: []
    description: "Deployment for ird_data_pipeline using Prefect."
  
  - name: ird-preprocess-pipeline-deployment
    entrypoint: ./src/pipelines/preprocess_flow.py:ird_preprocess_data_dag  # Change to your actual flow function if needed
    work_pool:
      name: ird-data-pool
      job_variables:
        image: cctongcastiel/ird_data_test_scrape:0.0.1
        dockerhub_username: "${{ secrets.DOCKER_USERNAME }}"
        dockerhub_password: "${{ secrets.DOCKER_PASSWORD }}"
    env:
      AWS_OPENSEARCH_ENDPOINT: "${{ secrets.AWS_OPENSEARCH_ENDPOINT }}"
      AWS_OPENSEARCH_USERNAME: "${{ secrets.AWS_OPENSEARCH_USERNAME }}"
      AWS_OPENSEARCH_PASSWORD: "${{ secrets.AWS_OPENSEARCH_PASSWORD }}"
      AWS_ACCESS_KEY_ID: "${{ secrets.AWS_ACCESS_KEY_ID }}"
      AWS_SECRET_ACCESS_KEY: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
    parameters: 
      config:
        ird_pdf_md_dir: data/ird_pdfs_md_original
        object_dir: src/core/objects/original
        output_filename: original
        run_pdf_to_md: false
        scrape_data: false
        save_pickle: true
        load_pickle: true
    schedule: null
    tags: []
    description: "Deployment for ird_preprocess_pipeline using Prefect."

  - name: ird-rag-pipeline-deployment
    entrypoint: ./src/pipelines/rag_flow.py:ird_rag_dag  # Change to your actual flow function if needed
    work_pool:
      name: ird-data-pool
      job_variables:
        image: cctongcastiel/ird_data_test_scrape:0.0.1
        dockerhub_username: "${{ secrets.DOCKER_USERNAME }}"
        dockerhub_password: "${{ secrets.DOCKER_PASSWORD }}"
    env:
      AWS_OPENSEARCH_ENDPOINT: "${{ secrets.AWS_OPENSEARCH_ENDPOINT }}"
      AWS_OPENSEARCH_USERNAME: "${{ secrets.AWS_OPENSEARCH_USERNAME }}"
      AWS_OPENSEARCH_PASSWORD: "${{ secrets.AWS_OPENSEARCH_PASSWORD }}"
      AWS_ACCESS_KEY_ID: "${{ secrets.AWS_ACCESS_KEY_ID }}"
      AWS_SECRET_ACCESS_KEY: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
    parameters: 
      config:
        ird_pdf_md_dir: data/ird_pdfs_md_original
        object_dir: src/core/objects/original
        output_filename: original
        run_pdf_to_md: false
        scrape_data: false
        save_pickle: true
        load_pickle: true
        queries:
          - "Which section of the Inland Revenue Ordinance imposed the basic charge of Salaries Tax?"
          - "Which 2 machinery or plants does the lease in included?"
          - "What does lease mean in legal term?"
          - "which section provides a form for double taxation relief?"
    schedule: null
    tags: []
    description: "Deployment for ird_preprocess_pipeline using Prefect."

